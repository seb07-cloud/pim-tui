---
phase: 07-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/azure/client_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Client.graphRequest is testable with mocked HTTP responses"
    - "Client.GetCurrentUser returns expected data from mocked API"
    - "Client.GetTenant returns expected data from mocked API"
    - "HTTP error responses are handled correctly"
  artifacts:
    - path: "internal/azure/client_test.go"
      provides: "Tests for Client HTTP methods with mocked responses"
      min_lines: 150
  key_links:
    - from: "internal/azure/client_test.go"
      to: "internal/azure/client.go"
      via: "imports and tests graphRequest via public methods"
      pattern: "GetCurrentUser|GetTenant"
---

<objective>
Add unit tests for Azure client HTTP methods using httptest.Server for mocking.

Purpose: Close gap #1 from VERIFICATION.md - "Azure client methods have tests with mocked HTTP responses"
Output: client_test.go with tests for graphRequest behavior via GetCurrentUser and GetTenant.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-test-coverage/07-01-SUMMARY.md

# Source file to test:
@internal/azure/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client HTTP mocking tests</name>
  <files>internal/azure/client_test.go</files>
  <action>
Create tests for Azure client HTTP methods using httptest.Server pattern:

1. **Create testable client helper:**
   - Function to create Client with custom httpClient and mock credential
   - Use httptest.NewServer to mock Graph API responses
   - Mock TokenCredential that returns a fake token

2. **TestGetCurrentUser** - table-driven:
   - Success case: server returns valid JSON user object → parses user ID
   - Error case: server returns 401 → returns auth error
   - Error case: server returns 500 → returns server error
   - Error case: server returns malformed JSON → returns parse error

3. **TestGetTenant** - table-driven:
   - Success case: server returns valid JSON tenant → parses tenant info
   - Error case: server returns 404 → returns not found error
   - Error case: server returns empty response → handles gracefully

4. **Test graphRequest retry behavior:**
   - First request 429 → retry → success → returns data
   - All retries 429 → returns rate limit error

**Mocking approach:**
```go
// Mock credential that returns a static token
type mockCredential struct{}

func (m *mockCredential) GetToken(ctx context.Context, opts policy.TokenRequestOptions) (azcore.AccessToken, error) {
    return azcore.AccessToken{Token: "mock-token", ExpiresOn: time.Now().Add(1 * time.Hour)}, nil
}

// Create client with mock server URL
func newTestClient(serverURL string) *Client {
    return &Client{
        cred:       &mockCredential{},
        httpClient: &http.Client{Timeout: 5 * time.Second},
    }
}
```

**Note:** Since graphRequest is unexported, test it indirectly through GetCurrentUser and GetTenant which use it internally. This tests the actual code path users exercise.
  </action>
  <verify>go test -v ./internal/azure/... -run "TestGetCurrentUser|TestGetTenant" passes</verify>
  <done>client_test.go exists with passing tests for GetCurrentUser and GetTenant using httptest mocking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v ./internal/azure/...` passes all tests
- [ ] Tests use httptest.Server for HTTP mocking
- [ ] Success and error cases are covered
- [ ] No new warnings or errors introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Client HTTP methods have mocked test coverage
- Error handling paths are tested
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-coverage/07-02-SUMMARY.md`
</output>
