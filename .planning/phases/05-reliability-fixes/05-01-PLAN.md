---
phase: 05-reliability-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/azure/groups.go
  - internal/azure/types.go
  - internal/azure/lighthouse.go
  - internal/ui/model.go
autonomous: true

must_haves:
  truths:
    - "go test -race ./... passes without data race warnings"
    - "Group activation uses roleDefinitionId from eligibility response"
    - "Errors in goroutines are logged, not silently ignored"
  artifacts:
    - path: "internal/azure/types.go"
      provides: "Group struct with RoleDefinitionID field"
      contains: "RoleDefinitionID"
    - path: "internal/azure/groups.go"
      provides: "Dynamic roleDefinitionId in activation/deactivation"
      contains: "g.RoleDefinitionID"
    - path: "internal/azure/lighthouse.go"
      provides: "Error logging for optional active assignments query"
      contains: "log.Printf"
  key_links:
    - from: "groups.go GetEligibleGroups"
      to: "Group struct"
      via: "stores RoleDefinition.ID"
      pattern: "RoleDefinitionID.*RoleDefinition\\.ID"
    - from: "groups.go ActivateGroup"
      to: "Group.RoleDefinitionID"
      via: "parameter passed from UI"
      pattern: "roleDefinitionID.*string"
---

<objective>
Fix reliability issues: proper sync in parallel code, dynamic roleDefinitionId for groups, error logging.

Purpose: Ensure no race conditions under -race flag, group activation works for Owner/Member roles, and debug info available for troubleshooting.
Output: Modified azure package files with reliability improvements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@internal/azure/types.go
@internal/azure/groups.go
@internal/azure/lighthouse.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RoleDefinitionID field to Group struct and populate it</name>
  <files>internal/azure/types.go, internal/azure/groups.go</files>
  <action>
    1. In types.go, add `RoleDefinitionID string` field to Group struct (after Description)
    2. In groups.go GetEligibleGroups(), when building the Group, set:
       `RoleDefinitionID: g.RoleDefinition.ID` from the pimGroupAssignment
    3. The RoleDefinition.ID is already available in pimGroupAssignment.RoleDefinition.ID
       and contains values like "member" or "owner" from the API response
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>Group struct has RoleDefinitionID field populated from eligibility response</done>
</task>

<task type="auto">
  <name>Task 2: Update ActivateGroup and DeactivateGroup to use dynamic roleDefinitionId</name>
  <files>internal/azure/groups.go</files>
  <action>
    1. Change ActivateGroup signature to accept roleDefinitionID parameter:
       `func (c *Client) ActivateGroup(ctx context.Context, groupID, roleDefinitionID, justification string, duration time.Duration) error`
    2. Replace hardcoded `"roleDefinitionId": "member"` with `"roleDefinitionId": roleDefinitionID`
    3. Change DeactivateGroup signature to accept roleDefinitionID parameter:
       `func (c *Client) DeactivateGroup(ctx context.Context, groupID, roleDefinitionID string) error`
    4. Replace hardcoded `"roleDefinitionId": "member"` with `"roleDefinitionId": roleDefinitionID`
    5. Remove the comment about "This might need to be fetched dynamically" - it's now dynamic

    Note: The UI code that calls these methods will need to pass the roleDefinitionID from the Group struct.
    This change is backward-compatible at the API level but requires caller updates.
  </action>
  <verify>go build ./... compiles (caller updates needed separately)</verify>
  <done>ActivateGroup and DeactivateGroup use dynamic roleDefinitionId parameter</done>
</task>

<task type="auto">
  <name>Task 3: Update UI to pass roleDefinitionID to Group activation/deactivation</name>
  <files>internal/ui/model.go</files>
  <action>
    In model.go startActivation() around line 1123:
    - Change: `client.ActivateGroup(ctx, v.ID, justification, duration)`
    - To: `client.ActivateGroup(ctx, v.ID, v.RoleDefinitionID, justification, duration)`

    In model.go startDeactivation() around line 1196:
    - Change: `client.DeactivateGroup(ctx, v.ID)`
    - To: `client.DeactivateGroup(ctx, v.ID, v.RoleDefinitionID)`

    The v variable is of type azure.Group which now has RoleDefinitionID field from Task 1.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>UI passes dynamic roleDefinitionID to group activation/deactivation</done>
</task>

<task type="auto">
  <name>Task 4: Add error logging for silently ignored errors</name>
  <files>internal/azure/lighthouse.go, internal/azure/groups.go</files>
  <action>
    In lighthouse.go GetLighthouseSubscriptions():
    1. Around line 345-376, when active assignments query fails or parsing fails:
       - Change from silent ignore to `log.Printf("[lighthouse] active assignments query failed: %v", activeErr)`
       - Add similar for JSON parse error: `log.Printf("[lighthouse] failed to parse active assignments: %v", jsonErr)`
    2. Around line 289-300, when getSubscriptionDetails fails:
       - Add: `log.Printf("[lighthouse] failed to get subscription details for %s: %v", id, err)`
    3. Around line 317-322, when getTenantNameByID fails:
       - Add: `log.Printf("[lighthouse] failed to get tenant name for %s: %v", tid, err)`

    In groups.go GetEligibleGroups():
    1. Around line 86, when getGroupName fails:
       - Change from silent to: `log.Printf("[groups] failed to get group name for %s: %v", id, err)`

    Pattern: Use `log.Printf("[component] message: %v", err)` for consistency.
    Keep the fallback behavior (continue without the optional data) but log the failure.
  </action>
  <verify>go build ./... compiles; grep -r "log.Printf" internal/azure/*.go shows new log statements</verify>
  <done>All previously silent errors are now logged with context</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go vet ./...` passes without warnings
- [ ] Group struct has RoleDefinitionID field in types.go
- [ ] GetEligibleGroups populates RoleDefinitionID from API response
- [ ] ActivateGroup accepts roleDefinitionID parameter
- [ ] DeactivateGroup accepts roleDefinitionID parameter
- [ ] UI model.go passes v.RoleDefinitionID to ActivateGroup
- [ ] UI model.go passes v.RoleDefinitionID to DeactivateGroup
- [ ] Error logging added for lighthouse active assignments (2 locations)
- [ ] Error logging added for lighthouse subscription details
- [ ] Error logging added for lighthouse tenant name lookup
- [ ] Error logging added for groups getGroupName
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- go build succeeds
- RoleDefinitionID flows from API response to activation request
- Silent error swallowing replaced with debug logging
</success_criteria>

<output>
After completion, create `.planning/phases/05-reliability-fixes/05-01-SUMMARY.md`
</output>
