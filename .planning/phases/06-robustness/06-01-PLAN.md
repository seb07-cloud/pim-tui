---
phase: 06-robustness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/pim-tui/main.go
  - internal/ui/model.go
autonomous: true

must_haves:
  truths:
    - "Ctrl+C exits cleanly with no orphaned goroutines"
    - "SIGTERM exits cleanly with no orphaned goroutines"
    - "Justification with control characters is rejected"
    - "Justification over 500 characters is rejected"
    - "Empty justification is rejected with feedback"
  artifacts:
    - path: "cmd/pim-tui/main.go"
      provides: "Signal handling for graceful shutdown"
      contains: "signal.Notify"
    - path: "internal/ui/model.go"
      provides: "Justification validation logic"
      contains: "validateJustification"
  key_links:
    - from: "main.go"
      to: "tea.Program"
      via: "context cancellation on signal"
      pattern: "signal\\.Notify.*SIGINT.*SIGTERM"
    - from: "model.go StateJustification"
      to: "validateJustification"
      via: "validation before activation"
      pattern: "validateJustification"
---

<objective>
Add graceful shutdown handling and input validation for robustness.

Purpose: Ensure the application exits cleanly on signals and validates user input properly.
Output: Signal handling in main.go, justification validation in model.go.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/05-reliability-fixes/05-01-SUMMARY.md

# Source files to modify
@cmd/pim-tui/main.go
@internal/ui/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add graceful shutdown signal handling</name>
  <files>cmd/pim-tui/main.go</files>
  <action>
    Add SIGINT and SIGTERM signal handling to main.go:

    1. Import "os/signal" and "syscall" packages
    2. Create a context with cancellation
    3. Set up signal.Notify to catch SIGINT and SIGTERM
    4. Create the tea.Program with tea.WithContext(ctx) to respect cancellation
    5. In a goroutine, wait for signals and call cancel() when received

    Pattern to follow:
    ```go
    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()

    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

    go func() {
        <-sigChan
        cancel()
    }()

    p := tea.NewProgram(m, tea.WithAltScreen(), tea.WithContext(ctx))
    ```

    Note: Bubble Tea's tea.WithContext allows the program to respect context cancellation,
    enabling clean exit when signals are received. The program will exit when the context
    is cancelled, allowing cleanup to happen.
  </action>
  <verify>go build ./cmd/pim-tui && echo "Build successful"</verify>
  <done>main.go handles SIGINT/SIGTERM via context cancellation</done>
</task>

<task type="auto">
  <name>Task 2: Add justification input validation</name>
  <files>internal/ui/model.go</files>
  <action>
    Add comprehensive justification validation:

    1. Create a `validateJustification(input string) (string, error)` function that:
       - Trims whitespace
       - Returns error if empty after trimming
       - Returns error if contains control characters (ASCII 0-31 except tab/newline, and 127)
       - Returns error if exceeds 500 characters after trimming
       - Returns the cleaned string if valid

    2. Update the StateJustification "enter" key handler to:
       - Call validateJustification() instead of just checking for empty
       - Log specific error message for validation failures
       - Only proceed to startActivation() if validation passes

    Implementation:
    ```go
    // validateJustification checks the justification input for validity
    // Returns the cleaned string if valid, or an error describing the issue
    func validateJustification(input string) (string, error) {
        cleaned := strings.TrimSpace(input)

        if cleaned == "" {
            return "", fmt.Errorf("justification is required")
        }

        // Check for control characters (ASCII 0-31 except 9=tab, 10=newline, 13=CR)
        for _, r := range cleaned {
            if r < 32 && r != 9 && r != 10 && r != 13 {
                return "", fmt.Errorf("justification contains invalid control characters")
            }
            if r == 127 { // DEL character
                return "", fmt.Errorf("justification contains invalid control characters")
            }
        }

        if len(cleaned) > 500 {
            return "", fmt.Errorf("justification exceeds 500 character limit (%d chars)", len(cleaned))
        }

        return cleaned, nil
    }
    ```

    3. In StateJustification handler, replace the empty check with:
    ```go
    case "enter":
        justification, err := validateJustification(m.justificationInput.Value())
        if err != nil {
            m.log(LogError, "%v", err)
            return m, nil
        }
        // Store validated justification for use in activation
        return m.startActivation()
    ```

    Note: The textinput already has CharLimit=500, but validation provides defense-in-depth
    and catches control characters that could cause issues with Azure API.
  </action>
  <verify>go build ./cmd/pim-tui && go vet ./... && echo "Build and vet successful"</verify>
  <done>Justification is validated for empty, control characters, and length before activation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/pim-tui` succeeds without errors
- [ ] `go vet ./...` passes with no warnings
- [ ] Signal handling imports present in main.go
- [ ] validateJustification function exists in model.go
- [ ] Justification validation called before startActivation()
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Signal handling properly set up in main.go
- Justification validation rejects empty, control chars, and overlength input
</success_criteria>

<output>
After completion, create `.planning/phases/06-robustness/06-01-SUMMARY.md`
</output>
