---
phase: 01-native-rest-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/azure/lighthouse.go
autonomous: true

must_haves:
  truths:
    - "armRequest uses SDK token acquisition only"
    - "armRequestWithBody uses SDK token acquisition only"
    - "No az rest references in lighthouse.go"
  artifacts:
    - path: "internal/azure/lighthouse.go"
      provides: "ARM API requests with SDK authentication"
      contains: "cred.GetToken"
  key_links:
    - from: "armRequest"
      to: "azidentity token acquisition"
      via: "cred.GetToken with ARM scope"
      pattern: "GetToken.*management\\.azure\\.com"
---

<objective>
Simplify ARM request functions in lighthouse.go to SDK-only path.

Purpose: Complete the migration by removing az rest fallback from ARM API calls.
Output: lighthouse.go with SDK-only authentication for all ARM requests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@internal/azure/lighthouse.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify armRequest to SDK-only path</name>
  <files>internal/azure/lighthouse.go</files>
  <action>
    1. Remove the `if c.useAzRest` branch from armRequest() (lines 154-157)
    2. armRequest should unconditionally:
       - Use c.cred.GetToken() with ARM scope (management.azure.com)
       - Create HTTP request with Authorization header
       - Execute via httpClient
       - Return response body or error
    3. Add retry logic for 429 responses (same pattern as graphRequest):
       - Max 3 retries
       - Exponential backoff: 1s, 2s, 4s
       - Only retry on 429 status code

    The function already has the SDK path implemented, just remove the az rest branch.
  </action>
  <verify>go build ./... compiles</verify>
  <done>armRequest uses SDK-only path with retry logic</done>
</task>

<task type="auto">
  <name>Task 2: Simplify armRequestWithBody to SDK-only path</name>
  <files>internal/azure/lighthouse.go</files>
  <action>
    1. Remove the `if c.useAzRest` branch from armRequestWithBody() (lines 425-427)
    2. armRequestWithBody should unconditionally:
       - Use c.cred.GetToken() with ARM scope
       - Marshal body to JSON
       - Create HTTP request with Authorization header and body
       - Execute via httpClient
       - Return response body or error
    3. Add retry logic for 429 responses (same pattern)

    Keep the existing JSON marshaling and request creation logic.
  </action>
  <verify>go build ./... compiles, grep "useAzRest" internal/azure/lighthouse.go returns nothing</verify>
  <done>armRequestWithBody uses SDK-only path, no useAzRest references remain</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `grep "useAzRest\|azRestRequest" internal/azure/lighthouse.go` returns no matches
- [ ] `grep "cred.GetToken" internal/azure/lighthouse.go` shows token acquisition
</verification>

<success_criteria>
- All tasks completed
- No az rest references in lighthouse.go
- Both armRequest and armRequestWithBody use SDK tokens
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-native-rest-migration/01-02-SUMMARY.md`
</output>
