---
phase: 01-native-rest-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/azure/client.go
autonomous: true

must_haves:
  truths:
    - "Application authenticates using azidentity.AzureCLICredential"
    - "No exec.Command or az CLI subprocess calls exist in codebase"
    - "Client struct has no useAzRest field"
  artifacts:
    - path: "internal/azure/client.go"
      provides: "Simplified SDK-only authentication"
      contains: "azidentity.NewAzureCLICredential"
  key_links:
    - from: "Client.graphRequest"
      to: "azidentity token acquisition"
      via: "cred.GetToken with graph scope"
      pattern: "GetToken.*graph\\.microsoft\\.com"
    - from: "Client.pimRequest"
      to: "azidentity token acquisition"
      via: "pimCred.GetToken with PIM scope"
      pattern: "GetToken.*azrbac\\.mspim\\.azure\\.com"
---

<objective>
Remove az CLI shelling from Azure client and use native azidentity SDK exclusively.

Purpose: Eliminate subprocess execution, improve reliability, reduce external dependencies, enable future testability with mock HTTP.
Output: Simplified client.go with SDK-only authentication path.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/INTEGRATIONS.md

@internal/azure/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify NewClient to SDK-only authentication</name>
  <files>internal/azure/client.go</files>
  <action>
    1. Remove the `az rest` test block in NewClient() (lines 69-89)
    2. Remove the `useAzRest` field from Client struct
    3. Replace NewDefaultAzureCredential with NewAzureCLICredential (more specific, matches user expectation of `az login`)
    4. Initialize both `cred` and `pimCred` with AzureCLICredential in NewClient (no lazy init)
    5. Return simple Client with both credentials set

    The new NewClient should:
    - Create AzureCLICredential once
    - Set it as both cred and pimCred (same credential works for all scopes)
    - Return Client with httpClient and credentials
    - Remove all az CLI path detection logic

    Keep the existing error handling pattern - return descriptive error if credential creation fails.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>NewClient() creates AzureCLICredential, no az CLI detection code remains</done>
</task>

<task type="auto">
  <name>Task 2: Remove az rest request functions and simplify graphRequest</name>
  <files>internal/azure/client.go</files>
  <action>
    1. Delete azCommand() function entirely (lines 38-64)
    2. Delete azRestRequest() function (line 153-155)
    3. Delete azRestRequestWithRetry() function (lines 158-198)
    4. Delete azRestRequestWithResource() function (lines 201-203)
    5. Remove the `if c.useAzRest` branch from graphRequest() - keep only the SDK path
    6. graphRequest() should now unconditionally use cred.GetToken() for Graph scope

    The resulting graphRequest should:
    - Always get token with graph.microsoft.com scope
    - Create HTTP request with Authorization header
    - Execute via httpClient
    - Return response body or error

    Keep existing retry logic pattern but implement it with HTTP (not az CLI):
    - Add retry with exponential backoff for 429 responses
    - Max 3 retries with 1s, 2s, 4s delays
  </action>
  <verify>go build ./... compiles, grep -r "azCommand\|azRestRequest\|useAzRest" internal/azure/ returns nothing</verify>
  <done>All az CLI execution code removed, graphRequest uses SDK-only path with retry</done>
</task>

<task type="auto">
  <name>Task 3: Simplify pimRequest to SDK-only path</name>
  <files>internal/azure/client.go</files>
  <action>
    1. Remove the `if c.useAzRest` branch from pimRequest() (lines 208-211)
    2. Remove lazy initialization of pimCred (it's now set in NewClient)
    3. pimRequest should unconditionally:
       - Use c.pimCred.GetToken() with PIM scope
       - Create HTTP request with Authorization header
       - Execute via httpClient
       - Return response body or error
    4. Add same retry logic as graphRequest (429 handling with backoff)

    Since pimCred is now initialized in NewClient(), remove the nil check and lazy init block.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>pimRequest uses SDK-only path, no lazy credential initialization</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `grep -r "exec.Command\|azCommand\|useAzRest\|azRestRequest" internal/azure/` returns no matches
- [ ] `grep "AzureCLICredential" internal/azure/client.go` shows credential creation
- [ ] No import of "os/exec" or "runtime" in client.go (unless needed elsewhere)
</verification>

<success_criteria>
- All tasks completed
- No az CLI subprocess execution code remains
- Client uses azidentity.AzureCLICredential for all authentication
- graphRequest and pimRequest use direct HTTP with SDK tokens
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-native-rest-migration/01-01-SUMMARY.md`
</output>
