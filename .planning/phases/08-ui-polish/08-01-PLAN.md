---
phase: 08-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/ui/views.go
  - internal/ui/styles.go
autonomous: true

must_haves:
  truths:
    - "Startup loading steps display in deterministic order (1-5)"
    - "Selected row in roles/groups/subscriptions list has clear white/inverted highlight"
    - "Long permission strings in detail panel wrap at path segments with indentation"
  artifacts:
    - path: "internal/ui/views.go"
      provides: "renderLoading with ordered steps, permission wrapping, cursor visibility"
    - path: "internal/ui/styles.go"
      provides: "Enhanced cursorStyle for clear visibility"
  key_links:
    - from: "renderLoading"
      to: "steps array"
      via: "deterministic ordering based on step index"
      pattern: "steps\\[\\d\\]"
    - from: "cursorStyle"
      to: "renderListItemWithExpiry"
      via: "style application on isCursor"
      pattern: "cursorStyle\\.Render"
---

<objective>
Polish the UI for improved visual feedback and readability.

Purpose: Address three UI annoyances identified during v1.1 testing:
1. Startup steps sometimes display out of order due to concurrent state updates
2. Cursor/selected row not clearly visible (purple on dark can be hard to see)
3. Long permission strings like `microsoft.directory/applications/credentials/update` overflow

Output: Updated views.go and styles.go with fixes for all three issues.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior UI work context:
@.planning/phases/04-ui-scrolling-fix/04-01-SUMMARY.md

# Source files to modify:
@internal/ui/views.go
@internal/ui/styles.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix startup step display ordering</name>
  <files>internal/ui/views.go</files>
  <action>
The renderLoading() function at line 69 shows startup progress steps. The current implementation determines step status based on model state (e.g., `m.client != nil`, `m.tenant != nil`), which can cause steps to show as complete out of order if concurrent loads finish in different order than displayed.

Fix approach:
1. Change the step display logic to be purely sequential - step N can only be "done" if step N-1 is also done
2. Keep the current status checks but enforce ordering:
   - Step 1 (Auth): done when m.client != nil
   - Step 2 (Tenant): done when Step 1 done AND m.tenant != nil
   - Step 3 (Roles): done when Step 2 done AND m.rolesLoaded
   - Step 4 (Groups): done when Step 2 done AND m.groupsLoaded
   - Step 5 (Subscriptions): done when Step 2 done AND m.lighthouseLoaded
3. Steps 3, 4, 5 run in parallel after Step 2, but display their "done" status based on actual completion, not ordering

The key fix: Steps 3-5 can complete in any order (parallel loading), but the "active" spinner should only show on the FIRST incomplete step after Step 2, not whichever is still loading.

Update lines 73-83:
```go
// Build step indicators - sequential display with parallel loading after step 2
authDone := m.client != nil
tenantDone := authDone && m.tenant != nil

steps := []struct {
    name   string
    done   bool
}{
    {"Authenticating with Graph API...", authDone},
    {"Loading Tenant Information", tenantDone},
    {"Loading PIM roles", tenantDone && m.rolesLoaded},
    {"Loading PIM groups", tenantDone && m.groupsLoaded},
    {"Loading Subscriptions", tenantDone && m.lighthouseLoaded},
}

// Determine active step: first incomplete step
activeIdx := -1
for i, step := range steps {
    if !step.done {
        activeIdx = i
        break
    }
}
```

Then update the display loop to use activeIdx instead of the individual step.active field.
  </action>
  <verify>go build ./... succeeds</verify>
  <done>Startup steps display in deterministic sequential order 1→2→3,4,5</done>
</task>

<task type="auto">
  <name>Task 2: Improve cursor/selected row visibility</name>
  <files>internal/ui/styles.go</files>
  <action>
The current cursorStyle at line 95-98 uses purple background with white text:
```go
cursorStyle = lipgloss.NewStyle().
    Background(colorHighlight).  // purple #7d56f4
    Foreground(lipgloss.Color("#ffffff")).
    Bold(true)
```

Purple on dark terminals can be hard to see. Improve visibility by:
1. Use white background with dark text (inverted style) for maximum contrast
2. Add the style to rebuildStyles() so it respects theme customization

Update cursorStyle definition:
```go
// Cursor/selection style - high contrast inverted for visibility
cursorStyle = lipgloss.NewStyle().
    Background(lipgloss.Color("#ffffff")).
    Foreground(lipgloss.Color("#000000")).
    Bold(true)
```

Also add cursorStyle rebuild in rebuildStyles() function to allow future theme customization.
  </action>
  <verify>go build ./... succeeds</verify>
  <done>Cursor style uses high-contrast white background with black text</done>
</task>

<task type="auto">
  <name>Task 3: Smart wrap long permission strings</name>
  <files>internal/ui/views.go</files>
  <action>
In renderRoleDetail() at lines 450-457, permission strings are rendered as:
```go
lines = append(lines, detailDimStyle.Render("  • "+perm))
```

Long permissions like `microsoft.directory/applications/credentials/update` can overflow the detail panel width.

Add a helper function wrapPermission() and use it:

```go
// wrapPermission wraps a permission string at path segments if it exceeds maxWidth
// Uses smart breaking at "/" boundaries with proper indentation
func wrapPermission(perm string, maxWidth int) []string {
    if len(perm) <= maxWidth {
        return []string{perm}
    }

    // Find a good break point at a "/" near the middle or before maxWidth
    parts := strings.Split(perm, "/")
    if len(parts) <= 2 {
        // Can't break meaningfully, just truncate with ellipsis
        return []string{perm[:maxWidth-3] + "..."}
    }

    // Build lines trying to keep under maxWidth
    var lines []string
    var current string
    indent := "    " // 4 spaces for continuation

    for i, part := range parts {
        separator := ""
        if i > 0 {
            separator = "/"
        }

        proposed := current + separator + part
        if len(proposed) > maxWidth && current != "" {
            lines = append(lines, current)
            current = indent + "/" + part
        } else {
            current = proposed
        }
    }
    if current != "" {
        lines = append(lines, current)
    }

    return lines
}
```

Then update renderRoleDetail() permissions section:
```go
if permissions := GetRolePermissions(role.RoleDefinitionID); len(permissions) > 0 {
    maxWidth := 40 // Reasonable width for detail panel
    for _, perm := range permissions {
        for _, line := range wrapPermission(perm, maxWidth) {
            lines = append(lines, detailDimStyle.Render("  • "+line))
        }
    }
}
```

Wait, that would add bullet to continuation lines. Better approach:
```go
for _, perm := range permissions {
    wrapped := wrapPermission(perm, maxWidth)
    for i, line := range wrapped {
        if i == 0 {
            lines = append(lines, detailDimStyle.Render("  • "+line))
        } else {
            lines = append(lines, detailDimStyle.Render("    "+line)) // indent continuation
        }
    }
}
```
  </action>
  <verify>go build ./... succeeds</verify>
  <done>Long permission strings wrap at "/" with proper indentation on continuation lines</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./...` passes (existing tests still work)
- [ ] No new linting errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Startup steps show consistent ordering
- Cursor is clearly visible on any terminal color scheme
- Long permissions wrap cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-ui-polish/08-01-SUMMARY.md`
</output>
